generator client {
  provider        = "prisma-client-js"
  /// Reference: https://www.prisma.io/docs/guides/database/multi-schema
  previewFeatures = ["multiSchema"]
}

/// Reference: https://www.prisma.io/docs/guides/database/multi-schema
datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  schemas           = ["public"]
}

model Clients {
  id                   String               @id @db.Uuid @default(uuid())
  name                 String               @default("")
  given_name           String               @default("")
  family_name          String               @default("")
  email                String               @default("")
  user_role            KnowiiUserRole       @default(USER)
  image_url            String               @default("")
  phone                String               @default("")
  user_id              String               @db.Uuid
  created_at           DateTime             @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())"))
  updated_at           DateTime             @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())")) @updatedAt
  admin_of             Communities[]        @relation("community_admins")
  member_of            Communities[]        @relation("community_members")
  owner_of             Communities[]        @relation("community_owners")

  @@schema("public")
  @@map("clients")
}

model Customers {
  user_id              String               @id @db.Uuid
  stripe_customer_id   String

  @@schema("public")
  @@map("customers")
}

model Prices {
  id                   String               @id @db.Uuid @default(uuid())
  product_id           String?              @db.Uuid
  active               Boolean?
  description          String?
  unit_amount          BigInt?
  currency             String?
  type                 PricingType?
  interval             PricingPlanInterval?
  interval_count       Int?
  trial_period_days    Int?
  metadata             Json?
  products             Products?            @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subscriptions        Subscriptions[]

  @@schema("public")
  @@map("prices")
}

model Products {
  id                   String               @id @db.Uuid @default(uuid())
  active               Boolean?
  name                 String?
  description          String?
  image                String?
  metadata             Json?
  prices               Prices[]
  subscriptions        Subscriptions[]

  @@schema("public")
  @@map("products")
}

model Subscriptions {
  id                   String               @id @db.Uuid @default(uuid())
  user_id              String               @db.Uuid
  status               SubscriptionStatus?
  metadata             Json?
  product_id           String?              @db.Uuid
  price_id             String?              @db.Uuid
  quantity             Int?
  cancel_at_period_end Boolean?
  created_at           DateTime             @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  current_period_start DateTime             @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  current_period_end   DateTime             @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  ended_at             DateTime?            @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  cancel_at            DateTime?            @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  canceled_at          DateTime?            @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  trial_start          DateTime?            @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  trial_end            DateTime?            @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  prices               Prices?              @relation(fields: [price_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  products             Products?            @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("public")
  @@map("subscriptions")
}

enum PricingPlanInterval {
  day
  week
  month
  year

  @@schema("public")
  @@map("pricing_plan_interval")
}

enum PricingType {
  one_time
  recurring

  @@schema("public")
  @@map("pricing_type")
}

enum SubscriptionStatus {
  trialing
  active
  canceled
  incomplete
  incomplete_expired
  past_due
  paused
  unpaid

  @@schema("public")
  @@map("subscription_status")
}

model Communities {
  id                   String                     @id @db.Uuid @default(uuid())
  name                 String                     @unique
  description          String                     @default("")
  visibility           KnowiiCommunityVisibility  @default(PUBLIC)
  created_at           DateTime                   @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())"))
  updated_at           DateTime                   @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())")) @updatedAt
  admins               Clients[]                  @relation("community_admins")
  members              Clients[]                  @relation("community_members")
  owners               Clients[]                  @relation("community_owners")
  resource_collections ResourceCollections[]      @relation("community_resource_collections")
  resources            Resources[]                @relation("community_resources")
  tags                 Tags[]                     @relation("community_tags")

  @@index([name], map: "idx_community_name")
  @@map("communities")
  @@schema("public")
}

model ResourceCollections {
  id                   String                     @id @db.Uuid @default(uuid())
  name                 String
  slug                 String                     @unique
  description          String                     @default("")
  community_id         String                     @db.Uuid
  created_at           DateTime                   @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())"))
  updated_at           DateTime                   @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())")) @updatedAt
  community            Communities                @relation("community_resource_collections", fields: [community_id], references: [id])
  resources            Resources[]                @relation("resource_collection_resources")

  @@index([name], map: "idx_resource_collection_name")
  @@map("resource_collections")
  @@schema("public")
}

/// The slug should be unique WITHIN a specific community
model Resources {
  id                       String                     @id @db.Uuid @default(uuid())
  name                     String
  description              String                     @default("")
  content                  String                     @default("")
  source                   String                     @default("")
  slug                     String
  up_votes                    Int                     @default(0)
  down_votes                  Int                     @default(0)
  community_id             String                     @db.Uuid
  resource_collection_id   String                     @db.Uuid
  created_at               DateTime                   @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())"))
  updated_at               DateTime                   @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())")) @updatedAt
  resource_collection      ResourceCollections        @relation("resource_collection_resources", fields: [resource_collection_id], references: [id])
  community                Communities                @relation("community_resources", fields: [community_id], references: [id])
  tags                     Tags[]                     @relation("resource_tags")

  @@index([slug], map: "idx_resource_slug")
  @@map("resources")
  @@schema("public")
}

model Tags {
  id                       String                     @id @db.Uuid @default(uuid())
  name                     String                     @unique
  community_id             String                     @db.Uuid
  community                Communities?               @relation("community_tags", fields: [community_id], references: [id])
  created_at               DateTime                   @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())"))
  updated_at               DateTime                   @db.Timestamptz(6) @default(dbgenerated("timezone('utc'::text, now())")) @updatedAt
  resources                Resources[]                @relation("resource_tags")

  @@index([name], map: "idx_tag_name")
  @@map("tags")
  @@schema("public")
}

enum KnowiiUserRole {
  USER
  ADMIN

  @@map("user_role")
  @@schema("public")
}

enum KnowiiCommunityVisibility {
  PUBLIC
  PRIVATE

  @@map("community_visibility")
  @@schema("public")
}

/// WARNING: Whenever adding a new table, think about enabling Row Level Security at the DB level if possible (cfr supabase-db-seed.sql)
